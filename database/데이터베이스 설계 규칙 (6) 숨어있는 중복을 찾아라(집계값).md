# 데이터베이스 설계 규칙 (6) 숨어있는 중복을 찾아라(집계값)

---

### 1. 숨어있는 중복

**posts (게시글)**

| **id** | **제목** | **내용** | **좋아요 수** | **사용자 id (FK)** |
| --- | --- | --- | --- | --- |
| 1 | 제목1 | 내용1 | 2 | 1 |

위 테이블의 구성에서는 임의의 데이터를 넣어봐도 중복 데이터가 발생하는 컬럼이 있진 않다. 하지만 숨어있는 중복이 있다.

**posts (게시글)**

| **id** | **제목** | **내용** | **좋아요 수** | **사용자 id (FK)** |
| --- | --- | --- | --- | --- |
| 1 | 제목1 | 내용1 | 2 | 1 |

**users (사용자)**

| id | 이름 |
| --- | --- |
| 1 | 땃쥐 |
| 2 | 땃고양이 |

**likes (좋아요)**

| id | 사용자 id (FK) | 게시글 id (FK) |
| --- | --- | --- |
| 1 | 1 | 1 |
| 2 | 2 | 1 |

- 2번 사용자가 1번 게시글에 좋아요를 했다가 취소했다고 하자.
- 그러면 likes 테이블에서 id=2 인 좋아요가 삭제될 것이다.
- 이것만 해선 안 된다. 좋아요가 삭제된다 하더라도 posts 테이블의 좋아요 수 역시 1 차감해줘야한다.
- 결국 일관성을 유지하기 위해 특정 데이터를 수정할 때, 다른 테이블의 데이터도 반드시 같이 수정해주어야 하는 상황이다.
- 이런 경우를 보고 **숨어있는 중복**이라고 얘기한다. 숨어있는 중복은 주로 집계(합계, 평균, 최대값 등)의 값에서 많이 나타난다.
- 숨은 데이터 중복이 발생하지 않게 만드려면 `posts` 테이블에서 `좋아요 수` 컬럼을 없애야 한다.
그러면 누군가는 ‘좋아요 수는 어떻게 구하나요?’를 물어볼 수도 있을 것이다.
그건 `likes` 테이블을 활용해서 `좋아요 수`를 카운팅하면 된다.

---

### 2. 결론
- 숨어있는 중복은 주로 집계(합계, 평균, 최대값 등)의 값에서 많이 나타난다.
- 집계값에 대해서는 별도의 칼럼으로 관리하지 않는 것이 숨은 중복을 없애는 방법이다.
- 성능상의 이유로 좋아요수를 별도로 관리할 수도 있다.(역정규화)  
  그러나 이 방법은 보통 다른 부분을 먼저 최적화하고 성능 개선을 할 방법이 없을 때 고려해볼만 하다.

**posts (게시글)**

| **id** | **제목** | **내용** | _좋아요 수(삭제)_ | **사용자 id (FK)** |
| --- | --- | --- |-------------| --- |
| 1 | 제목1 | 내용1 | _(삭제)_      | 1 |

**users (사용자)**

| id | 이름 |
| --- | --- |
| 1 | 땃쥐 |
| 2 | 땃고양이 |

**likes (좋아요)**

| id | 사용자 id (FK) | 게시글 id (FK) |
| --- | --- | --- |
| 1 | 1 | 1 |
| 2 | 2 | 1 |


---
